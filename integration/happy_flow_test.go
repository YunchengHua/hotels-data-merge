package integration

import (
	"context"
	"encoding/hex"
	"fmt"
	"testing"

	"github.com/YunchengHua/hotels-data-merge/internal/domain/hotel"
	"github.com/YunchengHua/hotels-data-merge/internal/handler"
	"github.com/YunchengHua/hotels-data-merge/internal/util"
	"github.com/golang/mock/gomock"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

const (
	mockHttpResp = "5b0a20207b0a20202020224964223a2022694a687a222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a202242656163682056696c6c61732053696e6761706f7265222c0a20202020224c61746974756465223a20312e3236343735312c0a20202020224c6f6e676974756465223a203130332e3832343030362c0a202020202241646472657373223a202220382053656e746f736120476174657761792c2042656163682056696c6c617320222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022303938323639222c0a20202020224465736372697074696f6e223a20222020546869732035207374617220686f74656c206973206c6f6361746564206f6e2074686520636f6173746c696e65206f662053696e6761706f72652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c2022427573696e65737343656e746572222c20225769466920222c2022447279436c65616e696e67222c202220427265616b66617374225d0a20207d2c0a20207b0a20202020224964223a2022536a7958222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a2022496e746572436f6e74696e656e74616c2053696e6761706f726520526f62657274736f6e2051756179222c0a20202020224c61746974756465223a206e756c6c2c0a20202020224c6f6e676974756465223a206e756c6c2c0a202020202241646472657373223a20222031204e616e736f6e20526f6164222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022323338393039222c0a20202020224465736372697074696f6e223a2022456e6a6f7920736f706869737469636174656420776174657266726f6e74206c6976696e6720617420746865206e657720496e746572436f6e74696e656e74616cc2ae2053696e6761706f726520526f62657274736f6e20517561792c206c75787572792773207072656665727265642061646472657373206e6573746c656420696e20746865206865617274206f6620526f62657274736f6e205175617920616c6f6e67207468652053696e6761706f72652052697665722c20776974682074686520434244206a7573742066697665206d696e7574657320647269766520617761792e204d61676e696679696e672074686520636f6d666f727473206f6620686f6d652c2065616368206f66206f7572203232352073747564696f7320616e6420737569746573206665617475726573206120686f7374206f662074686f7567687466756c20616d656e6974696573207468617420636f6d62696e65206d6f6465726e697479207769746820656c6567616e63652c207768696c7374206d61696e7461696e696e672066756e6374696f6e616c2070726163746963616c6974792e2054686520686f74656c20616c736f206665617475726573206120636869632c206c75787572696f757320436c756220496e746572436f6e74696e656e74616c204c6f756e67652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022416972636f6e222c2022427573696e65737343656e746572222c202242617468547562222c2022427265616b66617374222c2022447279436c65616e696e67222c2022426172225d0a20207d2c0a20207b0a20202020224964223a202266386339222c0a202020202244657374696e6174696f6e4964223a20313132322c0a20202020224e616d65223a202248696c746f6e205368696e6a756b7520546f6b796f222c0a20202020224c61746974756465223a2022222c0a20202020224c6f6e676974756465223a2022222c0a202020202241646472657373223a20223136302d303032332c205348494e4a554b552d4b552c20362d362d32204e495348492d5348494e4a554b552c204a4150414e222c0a202020202243697479223a2022546f6b796f222c0a2020202022436f756e747279223a20224a50222c0a2020202022506f7374616c436f6465223a20223136302d30303233222c0a20202020224465736372697074696f6e223a202248696c746f6e20546f6b796f206973206c6f636174656420696e205368696e6a756b752c20746865206865617274206f6620546f6b796f277320627573696e6573732c2073686f7070696e6720616e6420656e7465727461696e6d656e742064697374726963742c20616e6420697320616e20696465616c20706c61636520746f20657870657269656e6365206d6f6465726e204a6170616e2e204120636f6d706c696d656e746172792073687574746c65206f70657261746573206265747765656e2074686520686f74656c20616e64205368696e6a756b752073746174696f6e20616e642074686520546f6b796f204d6574726f2073756277617920697320636f6e6e656374656420746f2074686520686f74656c2e2052656c617820696e206f6e65206f6620746865206d6f6465726e204a6170616e6573652d7374796c6520726f6f6d7320616e642061646d697265207374756e6e696e6720636974792076696577732e2054686520686f74656c206f6666657273205769466920616e6420696e7465726e657420616363657373207468726f7567686f757420616c6c20726f6f6d7320616e64207075626c69632073706163652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022427573696e65737343656e746572222c2022447279436c65616e696e67222c202220427265616b66617374222c2022426172222c202242617468547562225d0a20207d0a5d5b0a20207b0a20202020224964223a2022694a687a222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a202242656163682056696c6c61732053696e6761706f7265222c0a20202020224c61746974756465223a20312e3236343735312c0a20202020224c6f6e676974756465223a203130332e3832343030362c0a202020202241646472657373223a202220382053656e746f736120476174657761792c2042656163682056696c6c617320222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022303938323639222c0a20202020224465736372697074696f6e223a20222020546869732035207374617220686f74656c206973206c6f6361746564206f6e2074686520636f6173746c696e65206f662053696e6761706f72652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c2022427573696e65737343656e746572222c20225769466920222c2022447279436c65616e696e67222c202220427265616b66617374225d0a20207d2c0a20207b0a20202020224964223a2022536a7958222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a2022496e746572436f6e74696e656e74616c2053696e6761706f726520526f62657274736f6e2051756179222c0a20202020224c61746974756465223a206e756c6c2c0a20202020224c6f6e676974756465223a206e756c6c2c0a202020202241646472657373223a20222031204e616e736f6e20526f6164222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022323338393039222c0a20202020224465736372697074696f6e223a2022456e6a6f7920736f706869737469636174656420776174657266726f6e74206c6976696e6720617420746865206e657720496e746572436f6e74696e656e74616cc2ae2053696e6761706f726520526f62657274736f6e20517561792c206c75787572792773207072656665727265642061646472657373206e6573746c656420696e20746865206865617274206f6620526f62657274736f6e205175617920616c6f6e67207468652053696e6761706f72652052697665722c20776974682074686520434244206a7573742066697665206d696e7574657320647269766520617761792e204d61676e696679696e672074686520636f6d666f727473206f6620686f6d652c2065616368206f66206f7572203232352073747564696f7320616e6420737569746573206665617475726573206120686f7374206f662074686f7567687466756c20616d656e6974696573207468617420636f6d62696e65206d6f6465726e697479207769746820656c6567616e63652c207768696c7374206d61696e7461696e696e672066756e6374696f6e616c2070726163746963616c6974792e2054686520686f74656c20616c736f206665617475726573206120636869632c206c75787572696f757320436c756220496e746572436f6e74696e656e74616c204c6f756e67652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022416972636f6e222c2022427573696e65737343656e746572222c202242617468547562222c2022427265616b66617374222c2022447279436c65616e696e67222c2022426172225d0a20207d2c0a20207b0a20202020224964223a202266386339222c0a202020202244657374696e6174696f6e4964223a20313132322c0a20202020224e616d65223a202248696c746f6e205368696e6a756b7520546f6b796f222c0a20202020224c61746974756465223a2022222c0a20202020224c6f6e676974756465223a2022222c0a202020202241646472657373223a20223136302d303032332c205348494e4a554b552d4b552c20362d362d32204e495348492d5348494e4a554b552c204a4150414e222c0a202020202243697479223a2022546f6b796f222c0a2020202022436f756e747279223a20224a50222c0a2020202022506f7374616c436f6465223a20223136302d30303233222c0a20202020224465736372697074696f6e223a202248696c746f6e20546f6b796f206973206c6f636174656420696e205368696e6a756b752c20746865206865617274206f6620546f6b796f277320627573696e6573732c2073686f7070696e6720616e6420656e7465727461696e6d656e742064697374726963742c20616e6420697320616e20696465616c20706c61636520746f20657870657269656e6365206d6f6465726e204a6170616e2e204120636f6d706c696d656e746172792073687574746c65206f70657261746573206265747765656e2074686520686f74656c20616e64205368696e6a756b752073746174696f6e20616e642074686520546f6b796f204d6574726f2073756277617920697320636f6e6e656374656420746f2074686520686f74656c2e2052656c617820696e206f6e65206f6620746865206d6f6465726e204a6170616e6573652d7374796c6520726f6f6d7320616e642061646d697265207374756e6e696e6720636974792076696577732e2054686520686f74656c206f6666657273205769466920616e6420696e7465726e657420616363657373207468726f7567686f757420616c6c20726f6f6d7320616e64207075626c69632073706163652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022427573696e65737343656e746572222c2022447279436c65616e696e67222c202220427265616b66617374222c2022426172222c202242617468547562225d0a20207d0a5d5b0a20207b0a20202020224964223a2022694a687a222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a202242656163682056696c6c61732053696e6761706f7265222c0a20202020224c61746974756465223a20312e3236343735312c0a20202020224c6f6e676974756465223a203130332e3832343030362c0a202020202241646472657373223a202220382053656e746f736120476174657761792c2042656163682056696c6c617320222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022303938323639222c0a20202020224465736372697074696f6e223a20222020546869732035207374617220686f74656c206973206c6f6361746564206f6e2074686520636f6173746c696e65206f662053696e6761706f72652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c2022427573696e65737343656e746572222c20225769466920222c2022447279436c65616e696e67222c202220427265616b66617374225d0a20207d2c0a20207b0a20202020224964223a2022536a7958222c0a202020202244657374696e6174696f6e4964223a20353433322c0a20202020224e616d65223a2022496e746572436f6e74696e656e74616c2053696e6761706f726520526f62657274736f6e2051756179222c0a20202020224c61746974756465223a206e756c6c2c0a20202020224c6f6e676974756465223a206e756c6c2c0a202020202241646472657373223a20222031204e616e736f6e20526f6164222c0a202020202243697479223a202253696e6761706f7265222c0a2020202022436f756e747279223a20225347222c0a2020202022506f7374616c436f6465223a2022323338393039222c0a20202020224465736372697074696f6e223a2022456e6a6f7920736f706869737469636174656420776174657266726f6e74206c6976696e6720617420746865206e657720496e746572436f6e74696e656e74616cc2ae2053696e6761706f726520526f62657274736f6e20517561792c206c75787572792773207072656665727265642061646472657373206e6573746c656420696e20746865206865617274206f6620526f62657274736f6e205175617920616c6f6e67207468652053696e6761706f72652052697665722c20776974682074686520434244206a7573742066697665206d696e7574657320647269766520617761792e204d61676e696679696e672074686520636f6d666f727473206f6620686f6d652c2065616368206f66206f7572203232352073747564696f7320616e6420737569746573206665617475726573206120686f7374206f662074686f7567687466756c20616d656e6974696573207468617420636f6d62696e65206d6f6465726e697479207769746820656c6567616e63652c207768696c7374206d61696e7461696e696e672066756e6374696f6e616c2070726163746963616c6974792e2054686520686f74656c20616c736f206665617475726573206120636869632c206c75787572696f757320436c756220496e746572436f6e74696e656e74616c204c6f756e67652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022416972636f6e222c2022427573696e65737343656e746572222c202242617468547562222c2022427265616b66617374222c2022447279436c65616e696e67222c2022426172225d0a20207d2c0a20207b0a20202020224964223a202266386339222c0a202020202244657374696e6174696f6e4964223a20313132322c0a20202020224e616d65223a202248696c746f6e205368696e6a756b7520546f6b796f222c0a20202020224c61746974756465223a2022222c0a20202020224c6f6e676974756465223a2022222c0a202020202241646472657373223a20223136302d303032332c205348494e4a554b552d4b552c20362d362d32204e495348492d5348494e4a554b552c204a4150414e222c0a202020202243697479223a2022546f6b796f222c0a2020202022436f756e747279223a20224a50222c0a2020202022506f7374616c436f6465223a20223136302d30303233222c0a20202020224465736372697074696f6e223a202248696c746f6e20546f6b796f206973206c6f636174656420696e205368696e6a756b752c20746865206865617274206f6620546f6b796f277320627573696e6573732c2073686f7070696e6720616e6420656e7465727461696e6d656e742064697374726963742c20616e6420697320616e20696465616c20706c61636520746f20657870657269656e6365206d6f6465726e204a6170616e2e204120636f6d706c696d656e746172792073687574746c65206f70657261746573206265747765656e2074686520686f74656c20616e64205368696e6a756b752073746174696f6e20616e642074686520546f6b796f204d6574726f2073756277617920697320636f6e6e656374656420746f2074686520686f74656c2e2052656c617820696e206f6e65206f6620746865206d6f6465726e204a6170616e6573652d7374796c6520726f6f6d7320616e642061646d697265207374756e6e696e6720636974792076696577732e2054686520686f74656c206f6666657273205769466920616e6420696e7465726e657420616363657373207468726f7567686f757420616c6c20726f6f6d7320616e64207075626c69632073706163652e222c0a2020202022466163696c6974696573223a205b22506f6f6c222c20225769466920222c2022427573696e65737343656e746572222c2022447279436c65616e696e67222c202220427265616b66617374222c2022426172222c202242617468547562225d0a20207d0a5d"
)

func TestHappyFlow(t *testing.T) {
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()

	ctx := context.Background()
	rawResp, err := hex.DecodeString(mockHttpResp)
	require.NoError(t, err)

	mockHttpService := util.NewMockHttpService(ctrl)
	hotelService := hotel.NewService(hotel.NewRepo(mockHttpService))
	mockHttpService.EXPECT().Get(gomock.Any(), hotel.Url1).Return(rawResp, nil)
	mockHttpService.EXPECT().Get(gomock.Any(), hotel.Url2).Return(rawResp, nil)
	mockHttpService.EXPECT().Get(gomock.Any(), hotel.Url2).Return(rawResp, nil)
	err = hotel.FetchFn(ctx, hotelService)
	require.NoError(t, err)

	hotelsHandler := handler.NewDefaultHotelsHandler()
	resp, err := hotelsHandler.Execute(ctx, map[string]string{
		handler.ParamNameDestinationIDs: "123",
	})
	assert.NoError(t, err)
	fmt.Println(resp.(*handler.HotelsResponse))
}
